name: ProductScraper CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/scrapers/**'
      - 'src/scrapers/config/**'
      - 'src/scrapers/executor/**'
      - 'src/scrapers/models/**'
      - 'src/scrapers/parser/**'
      - 'src/scrapers/schemas/**'
      - '.github/workflows/ci-cd.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/scrapers/**'
      - 'src/scrapers/config/**'
      - 'src/scrapers/executor/**'
      - 'src/scrapers/models/**'
      - 'src/scrapers/parser/**'
      - 'src/scrapers/schemas/**'
      - '.github/workflows/ci-cd.yml'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Cache uv dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/uv
        key: ${{ runner.os }}-uv-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-uv-

    - name: Create virtual environment
      run: |
        uv venv

    - name: Install dependencies
      run: |
        uv pip install -e .[dev]

    - name: Run unit tests
      run: |
        pytest tests/unit/ -v --tb=short --cov=src --cov-report=xml --cov-report=term

    - name: Run integration tests
      run: |
        pytest tests/integration/ -v --tb=short -m "not slow"

    - name: Run performance tests
      run: |
        pytest tests/integration/ -v --tb=short -m "slow" --durations=10

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  quality-gate:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Create virtual environment
      run: |
        uv venv

    - name: Install dependencies
      run: |
        uv pip install -e .[dev]

    - name: Run quality validation
      run: |
        # Run data quality scorer validation on sample data
        python -c "
        from src.core.data_quality_scorer import DataQualityScorer, is_product_high_quality
        import json

        # Load test data
        with open('tests/fixtures/scraper_test_data.json', 'r') as f:
            test_data = json.load(f)

        scorer = DataQualityScorer()
        total_records = 0
        high_quality_records = 0

        for scraper, data in test_data.items():
            if 'test_skus' in data:
                for sku in data['test_skus'][:5]:  # Test first 5 SKUs per scraper
                    # Mock record with SKU
                    record = {'SKU': sku, 'Name': f'Test {scraper} product'}
                    score, _ = scorer.score_record(record)
                    total_records += 1
                    if is_product_high_quality(record):
                        high_quality_records += 1

        quality_rate = high_quality_records / total_records if total_records > 0 else 0
        print(f'Quality validation: {high_quality_records}/{total_records} records pass quality gate ({quality_rate:.1%})')

        # Quality gate: at least 60% of test records should pass (allowing for incomplete mock data)
        assert quality_rate >= 0.6, f'Quality gate failed: only {quality_rate:.1%} records pass validation'
        "

  deploy:
    runs-on: ubuntu-latest
    needs: [test, quality-gate]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to staging
      run: |
        echo "Deployment to staging environment"
        # Add actual deployment steps here
        echo "Staging deployment completed"