name: CD - Platform Deployment

on:
  push:
    branches: [ main ]
    paths:
      - 'src/scrapers/**'
      - '.github/workflows/cd-deployment.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run pre-deployment validation
      run: |
        python platform_test_scrapers.py --all
      env:
        PYTHONPATH: ${{ github.workspace }}

  deploy:
    needs: validate
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Apify CLI
      run: npm install -g apify-cli

    - name: Configure Apify
      run: |
        apify login
      env:
        APIFY_API_TOKEN: ${{ secrets.APIFY_API_TOKEN }}

    - name: Deploy scrapers
      run: |
        python scripts/deploy_scrapers.py
      env:
        PYTHONPATH: ${{ github.workspace }}
        APIFY_API_TOKEN: ${{ secrets.APIFY_API_TOKEN }}

    - name: Validate deployment
      run: |
        python scripts/validate_deployment.py
      env:
        PYTHONPATH: ${{ github.workspace }}
        APIFY_API_TOKEN: ${{ secrets.APIFY_API_TOKEN }}

    - name: Generate deployment report
      run: |
        echo "## Deployment Report" > deployment_report.md
        echo "- **Date:** $(date)" >> deployment_report.md
        echo "- **Environment:** ${{ github.event.inputs.environment || 'staging' }}" >> deployment_report.md
        echo "- **Commit:** ${{ github.sha }}" >> deployment_report.md
        echo "- **Status:** ‚úÖ Successful" >> deployment_report.md

    - name: Upload deployment report
      uses: actions/upload-artifact@v4
      with:
        name: deployment-report
        path: deployment_report.md

  notify:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Notify deployment status
      run: |
        case "${{ needs.deploy.result }}" in
          success)
            echo "üéâ Deployment successful!"
            ;;
          skipped)
            echo "‚ö†Ô∏è Deployment skipped - check validation job or environment configuration"
            ;;
          *)
            echo "‚ùå Deployment failed or cancelled!"
            exit 1
            ;;
        esac