name: CD - Local Deployment

on:
  push:
    branches: [ main ]
    paths:
      - 'src/scrapers/**'
      - 'src/scrapers/config/**'
      - 'src/scrapers/executor/**'
      - 'src/scrapers/models/**'
      - 'src/scrapers/parser/**'
      - 'src/scrapers/schemas/**'
      - '.github/workflows/cd-deployment.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Create virtual environment
      run: |
        uv venv

    - name: Install dependencies
      run: |
        uv pip install -e .

    - name: Run pre-deployment validation
      run: |
        uv run python tests/platform_test_scrapers.py --all
      env:
        PYTHONPATH: ${{ github.workspace }}

  deploy:
    needs: validate
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Create virtual environment
      run: |
        uv venv

    - name: Install dependencies
      run: |
        uv pip install -e .

    - name: Deploy scrapers locally
      run: |
        echo "Local deployment completed - scrapers are ready to run"
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Validate deployment
      run: |
        uv run python tests/platform_test_scrapers.py --all --local
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Generate deployment report
      run: |
        echo "## Local Deployment Report" > deployment_report.md
        echo "- **Date:** $(date)" >> deployment_report.md
        echo "- **Environment:** ${{ github.event.inputs.environment || 'staging' }}" >> deployment_report.md
        echo "- **Commit:** ${{ github.sha }}" >> deployment_report.md
        echo "- **Status:** ‚úÖ Successful" >> deployment_report.md

    - name: Upload deployment report
      uses: actions/upload-artifact@v4
      with:
        name: deployment-report
        path: deployment_report.md

  notify:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Notify deployment status
      run: |
        case "${{ needs.deploy.result }}" in
          success)
            echo "üéâ Deployment successful!"
            ;;
          skipped)
            echo "‚ö†Ô∏è Deployment skipped - check validation job or environment configuration"
            ;;
          *)
            echo "‚ùå Deployment failed or cancelled!"
            exit 1
            ;;
        esac