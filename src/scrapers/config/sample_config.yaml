#
# Comprehensive Scraper Configuration Example
#
# This file serves as a template and documentation for creating robust YAML-based scrapers.
# It showcases a variety of actions and best practices.
#

# Required: Unique name for the scraper. Used for logging and history tracking.
name: "Comprehensive Example Scraper"

# Required: The base URL of the target website.
base_url: "https://www.example-shop.com"

# Optional: Default timeout in seconds for wait actions (default: 30).
timeout: 45

# Optional: Default number of retries for failed actions (default: 3).
retries: 3

#
# Selectors: Define the data points you want to extract.
#
selectors:
  # Extracts the product name from the first h1 tag or an element with class .product-title
  - name: "product_name"
    selector: "h1, .product-title"
    attribute: "text"
  
  # Extracts the price.
  - name: "price"
    selector: ".price"
    attribute: "text"

  # Extracts the UPC/SKU from the page for verification.
  - name: "upc"
    selector: ".product-sku"
    attribute: "text"

  # Extracts all image URLs from the product gallery.
  - name: "image_urls"
    selector: ".product-gallery img"
    attribute: "src"
    multiple: true

  # Extracts structured data from a JSON-LD script tag.
  - name: "product_json_data"
    selector: "script[type='application/ld+json']"

#
# Workflow: A sequence of actions to perform.
#
workflows:
  # It's good practice to handle cookie banners at the start.
  - action: "conditional_click"
    params:
      selector: "#cookie-consent-accept-button"
      timeout: 3 # Wait a few seconds for the banner to appear.

  # Step 1: Navigate to the search results page for a given SKU.
  - action: "navigate"
    params:
      url: "https://www.example-shop.com/search?q={sku}"

  # Step 2: Wait for either the search results or a "no results" message to appear.
  # This uses the enhanced 'wait_for' to handle multiple possible outcomes.
  - action: "wait_for"
    params:
      selector: [".search-results-container", ".no-results-message"]
      timeout: 15

  # Step 3: Explicitly check for a "no results" condition.
  # This uses the patterns defined in the 'validation' section below.
  - action: "check_no_results"

  # Step 4: If the 'no_results_found' flag was set, stop this workflow.
  - action: "conditional_skip"
    params:
      if_flag: "no_results_found"

  # Step 5: Click the first search result that is not a sponsored ad.
  # This uses the enhanced 'click' action with filtering.
  - action: "click"
    params:
      selector: ".search-result-item a.product-link"
      filter_text_exclude: "sponsored" # Regex to filter out ad links.
      index: 0 # Click the first element in the filtered list.

  # Step 6: Wait for the product detail page to load.
  - action: "wait_for"
    params:
      selector: ".product-details-page"
      timeout: 20

  # Step 7: Verify we are on the correct product page by checking the UPC/SKU.
  # This uses the 'verify' action with a fuzzy number match to handle variations.
  - action: "verify"
    params:
      selector: ".product-sku"
      expected_value: "{sku}"
      match_mode: "fuzzy_number"
      on_failure: "fail_workflow" # Stop if the SKU doesn't match.

  # Step 8: Scroll down to ensure lazy-loaded images or details are visible.
  - action: "scroll"
    params:
      direction: "down"
      amount: 800 # Scroll down 800 pixels.

  # Step 9: Extract the primary data using the defined selectors.
  - action: "extract"
    params:
      fields: ["product_name", "price", "image_urls"]

  # Step 10: Extract additional data from an embedded JSON object.
  - action: "extract_from_json"
    params:
      selector: "script[type='application/ld+json']"
      field: "brand_from_json"
      json_path: "brand.name" # Extracts brand name from the JSON data.

#
# Login: Configuration for sites that require authentication.
#
login:
  url: "https://www.example-shop.com/login"
  username_field: "#username"
  password_field: "#password"
  submit_button: "#login-button"
  success_indicator: ".account-dashboard" # An element that only appears after a successful login.

#
# Anti-Detection: Settings to make the scraper appear more human.
#
anti_detection:
  enable_captcha_detection: true
  enable_rate_limiting: true
  enable_human_simulation: true
  rate_limit_min_delay: 2.0
  rate_limit_max_delay: 5.0

#
# Validation: Patterns to detect 'no results' pages.
#
validation:
  no_results_selectors:
    - ".no-results-message"
    - "#search-results-empty"
  no_results_text_patterns:
    - "no products found"
    - "your search returned no results"
